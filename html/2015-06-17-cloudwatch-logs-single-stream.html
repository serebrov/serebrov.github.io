<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CloudWatch Logs - how to log data from multiple instances to the single stream</title>

    <!-- Bootstrap -->
    <!-- https://github.com/necolas/normalize.css -->
    <link href="/css/normalize.css" rel="stylesheet">
    <!-- https://github.com/oxalorg/sakura -->
    <link href="/css/sakura.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/custom.css"/>

    <!-- https://prismjs.com/ -->
    <!-- Plugins: Line Highlight, Line Numbers, Autolinker, File Highlight,
                  Keep Markup, Normalize Whitespace
    -->
    <!-- Langs: bash, c, cpp, docker, go, haskell, json, makefile, php, plsql,
                python, rust, smalltalk, sql, vim, yaml
    -->
    <link href="/css/prism.css" rel="stylesheet">
    <script src="/js/prism.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  </head>
  <body>
    <div class="content">
      <div class="page-header">
        <a href="/">vim, git, aws and other three-letter words</a>
      </div>
      <div class="post-title">
          <h1>CloudWatch Logs - how to log data from multiple instances to the single stream</h1>
      </div>
      <div class="post-body">
          <p><a href="/html/2015-05-20-cloudwatch-setup.html">After using CloudWatch Logs for some time</a> I found that it is very inconvenient to have one stream per instance.
The Logs UI is really complex to use - I need to remember instance names, open the log group I need and then go into each instance logs one-by-one to check them.</p>
<p>A more convenient alternative is to use one stream like <code>error_log</code> for all instances.
<!-- more --></p>
<p><strong>Update</strong>: logging to the same stream from multiple sources is not recommended and may cause duplicate records (although in my case this is fine). Check the comments for more information and thanks Sergei for pointing this out.</p>
<p>To use the single stream, we can just set a static string for stream name instead of {instance_id}, like this (see <code>log_stream_name = error_log</code>):</p>
<pre><code class="lang-yaml">
  AWSEBAutoScalingGroup:
    Metadata:
      &quot;AWS::CloudFormation::Init&quot;:
        CWLogsAgentConfigSetup:
          files:
            &quot;/tmp/cwlogs/conf.d/apache-error.conf&quot;:
              content : |
                [apache-error_log]
                file = `{&quot;Fn::FindInMap&quot;:[&quot;CWLogs&quot;, &quot;WebErrorLogGroup&quot;, &quot;LogFile&quot;]}`
                log_group_name = `{ &quot;Ref&quot; : &quot;AWSEBCloudWatchLogs8832c8d3f1a54c238a40e36f31ef55a0WebErrorLogGroup&quot; }`
                log_stream_name = error_log
                datetime_format = `{&quot;Fn::FindInMap&quot;:[&quot;CWLogs&quot;, &quot;WebErrorLogGroup&quot;, &quot;TimestampFormat&quot;]}`
              mode  : &quot;000400&quot;
              owner : root
              group : root
</code></pre>
<p>Now we need to make sure our log records contain instance id or IP address, so we can understand which instance generated each log record.</p>
<p>Fortunately, python application logs in the apache&#39;s error_log already have IP address, so nothing to do here. The log looks like this:</p>
<pre><code class="lang-text">[Wed Jun 17 16:02:46.944612 2015] [:error] [pid 20405] [remote 172.31.11.92:0] mod_wsgi (pid=20405): Exception occurred processing WSGI script &#39;/opt/python/current/app/application.py&#39;.
[Wed Jun 17 16:02:46.944686 2015] [:error] [pid 20405] [remote 172.31.11.92:0] Traceback (most recent call last):
[Wed Jun 17 16:02:46.944711 2015] [:error] [pid 20405] [remote 172.31.11.92:0] File &quot;/opt/python/run/venv/lib/python2.7/site-packages/flask/app.py&quot;, line 1701, in __call__
...
</code></pre>
<p>Here <code>[remote 172.31.11.92:0]</code> is a private instance IP.</p>
<p>For custom logs generated by application it is better to use python&#39;s <code>logging</code> module where we can set a custom format and include instance id.</p>
<p>Here is an example of how to get EC2 instance id or IP or any other metadata using boto:</p>
<pre><code class="lang-python">&gt;&gt;&gt; from boto.utils import get_instance_metadata
&gt;&gt;&gt; print get_instance_metadata()
{
  &#39;ami-manifest-path&#39;: &#39;(unknown)&#39;,
  &#39;instance-type&#39;: &#39;t2.small&#39;,
  &#39;instance-id&#39;: &#39;i-977a265c&#39;,
  &#39;iam&#39;: {...}, &#39;local-hostname&#39;:
  &#39;ip-172-32-22-111.ap-southeast-1.compute.internal&#39;,
  &#39;network&#39;: {... },
  &#39;hostname&#39;: &#39;ip-172-32-22-111.ap-southeast-1.compute.internal&#39;,
  &#39;ami-id&#39;: &#39;ami-44d4e414&#39;,
  &#39;instance-action&#39;: &#39;none&#39;,
  &#39;profile&#39;: &#39;default-hvm&#39;,
  &#39;reservation-id&#39;: &#39;r-fde77b77&#39;,
  &#39;security-groups&#39;: [&#39;ci-servers&#39;, &#39;awseb-e-3uijdzdiad-stack-AWSEBSecurityGroup-1R39VECLNK1YK&#39;],
  &#39;metrics&#39;: {&#39;vhostmd&#39;: &#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&#39;},
  &#39;mac&#39;: &#39;06:2d:22:2b:22:22&#39;,
  &#39;public-ipv4&#39;: &#39;52.77.99.111&#39;,
  &#39;services&#39;: {&#39;domain&#39;: &#39;amazonaws.com&#39;},
  &#39;local-ipv4&#39;: &#39;172.32.22.111&#39;,
  &#39;placement&#39;: {&#39;availability-zone&#39;: &#39;ap-southeast-1b&#39;},
  &#39;ami-launch-index&#39;: &#39;0&#39;,
  &#39;public-hostname&#39;: &#39;ec2-52-77-99-111.ap-southeast-1.compute.amazonaws.com&#39;, &#39;public-keys&#39;: {...},
  &#39;block-device-mapping&#39;: {&#39;ami&#39;: &#39;/dev/xvda&#39;, &#39;root&#39;: &#39;/dev/xvda&#39;}
}
</code></pre>
<p>And now here is how you can setup a logger to have instance id for log records:</p>
<pre><code class="lang-python">
import logging
from boto.utils import get_instance_metadata

# Logging configuration
# Note: - `with_time` formatter contains non-standard [%(hostname)s] parameter
LOGGING_CONFIG = {
    &#39;version&#39;: 1,
    &#39;disable_existing_loggers&#39;: False,
    &#39;formatters&#39;: {
        &#39;with_time&#39;: {
            &#39;format&#39;: &#39;[%(asctime)s] [%(levelname)s] [%(hostname)s] -- %(message)s&#39;,
            &#39;datefmt&#39;: &#39;%Y-%m-%d %H:%M:%S&#39;
        }
    },
    &#39;handlers&#39;: {
        &#39;sys_info&#39;: {
            &#39;class&#39;: &#39;logging.handlers.RotatingFileHandler&#39;,
            &#39;filename&#39;: &#39;log/sysinfo.log&#39;,
            &#39;formatter&#39;: &#39;with_time&#39;
        },
        &#39;console&#39;: {
            &#39;class&#39;: &#39;logging.StreamHandler&#39;,
            &#39;formatter&#39;: &#39;with_time&#39;
        }
    },
    &#39;loggers&#39;: {
        &#39;sys_info&#39;: {
            &#39;level&#39;: &#39;INFO&#39;,
            &#39;handlers&#39;: [&#39;sys_info&#39;]
        }
    }
}
# Use `APP_ENV` environment variable or `development` by default
# We assume that `development` is local and all other enviroments are
# on Amazon EC2 instances
APP_ENV = os.environ[&#39;APP_ENV&#39;] if &#39;APP_ENV&#39; in os.environ else &#39;development&#39;

# A log filter class to add custom `hostname` property to log records
class LogHostnameFilter(logging.Filter):
    def filter(self, record):
        if APP_ENV != &#39;development&#39;:
            meta = get_instance_metadata()
            record.hostname = meta[&#39;instance-id&#39;]
        else:
            record.hostname = &#39;localhost&#39;
        return True

# Create and configure logger
logging.config.dictConfig(LOGGING_CONFIG)
sys_info_logger = logging.getLogger(&#39;sys_info&#39;)
sys_info_logger.addFilter(LogHostnameFilter())

# Usage example:
sys_info_logger.info(&#39;Access token denied: %s&#39; % access_token)
</code></pre>
<h2 id="links">Links</h2>
<p><a href="/html/2015-05-20-cloudwatch-setup.html">Elastic Beanstalk - how to setup CloudWatch Logs</a></p>

      </div>
      <div>
<a href="https://stackexchange.com/users/261528">
<img src="https://stackexchange.com/users/flair/261528.png?theme=clean" width="208" height="58" alt="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites">
</a>
      </div>
      <div>
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = 'https://serebrov.github.io/html/2015-06-17-cloudwatch-logs-single-stream.html';  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = 'html/2015-06-17-cloudwatch-logs-single-stream.html'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://serebrov.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58056088-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>

