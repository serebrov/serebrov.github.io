<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AWS - Deployment via OpsWorks from the command line</title>

    <!-- Bootstrap -->
    <!-- https://github.com/necolas/normalize.css -->
    <link href="/css/normalize.css" rel="stylesheet">
    <!-- https://github.com/oxalorg/sakura -->
    <link href="/css/sakura.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/custom.css"/>

    <!-- https://prismjs.com/ -->
    <!-- Plugins: Line Highlight, Line Numbers, Autolinker, File Highlight,
                  Keep Markup, Normalize Whitespace
    -->
    <!-- Langs: bash, c, cpp, docker, go, haskell, json, makefile, php, plsql,
                python, rust, smalltalk, sql, vim, yaml
    -->
    <link href="/css/prism.css" rel="stylesheet">
    <script src="/js/prism.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  </head>
  <body>
    <div class="content">
      <div class="page-header">
        <a href="/">vim, git, aws and other three-letter words</a>
      </div>
      <div class="post-title">
          <h1>AWS - Deployment via OpsWorks from the command line</h1>
      </div>
      <div class="post-body">
          <p>Below is a simple python script which performs application deployment using OpsWorks API library (boto).
Script performs following steps</p>
<ul>
<li>Execute &#39;update_custom_cookbooks&#39; deployment command and wait for successful completion (or stop with an error)</li>
<li>Execute &#39;deploy&#39; command and wait for completion</li>
</ul>
<!-- more -->
<p>At the top there are aws configuration parameters (aws_access_key, aws_secret_key) - these can be left empty if the script is launched on the AWS instance which has IAM role assigned.</p>
<pre><code class="lang-python">#!/usr/bin/python

import boto.opsworks
from datetime import datetime
import time
import sys
import logging

stack_id=&quot;mystackid&quot; # see this in the opsworks stack properties
app_id=&quot;myappid&quot; # see this in the opsworks app properties
aws_access_key = &quot;my_access_key&quot;
aws_secret_key = &quot;my_secret_key&quot;
ec2_region_name = &#39;us-east-1&#39; # your region name
# see region endpoints - http://docs.aws.amazon.com/general/latest/gr/rande.html
ec2_region_endpoint = &#39;region_endpoint&#39;

def wait_for_deployment(deployment_id):
    print(&#39;Waiting for deployment %s to complete&#39; % deployment_id)
    while True:
        result = opsworks.describe_deployments(deployment_ids=[deployment_id])
        data = result[&#39;Deployments&#39;][0]
        if data[&#39;Status&#39;] == &#39;running&#39;:
            sys.stdout.write(&#39;.&#39;)
        elif data[&#39;Status&#39;] == &#39;successful&#39;:
            print(&#39;Done %s&#39; % deployment_id)
            return
        elif data[&#39;Status&#39;] == &#39;failed&#39;:
            print(&#39;Failed %s&#39; % deployment_id)
            raise Exception(&#39;Deployment failed&#39;)
        else:
            raise Exception(&#39;Unknown deployment stauts: %s&#39; % data[&#39;Status&#39;])
        sys.stdout.flush()
        time.sleep(3)

if aws_access_key:
    opsworks = boto.opsworks.connect_to_region(ec2_region_name, aws_access_key_id=aws_access_key, aws_secret_access_key=aws_secret_key)
else:
    opsworks = boto.opsworks.connect_to_region(ec2_region_name)

result = opsworks.create_deployment(stack_id, {&quot;Name&quot;:&quot;update_custom_cookbooks&quot;}, app_id)
print(&#39;Update custom cookbooks %s&#39; % result)
wait_for_deployment(result[&#39;DeploymentId&#39;])

result = opsworks.create_deployment(stack_id, {&quot;Name&quot;:&quot;deploy&quot;}, app_id)
print(&#39;Deploy %s&#39; % result)
wait_for_deployment(result[&#39;DeploymentId&#39;])

</code></pre>
<p>The script launches deployment command and then polls its status every three seconds until it completes or fails.
Results look like this:</p>
<pre><code class="lang-bash">$ ./deploy.py
Update custom cookbooks {u&#39;DeploymentId&#39;: u&#39;e83a0100-52b2-2fe1-ad26-1db85b62dbfb&#39;}
Waiting for deployment e83a0100-52b2-2fe1-ad26-1db85b62dbfb to complete
........................Done e83a0100-52b2-2fe1-ad26-1db85b62dbfb
Deploy {u&#39;DeploymentId&#39;: u&#39;85fda652-f215-25fd-b13d-e061adccf535&#39;}
Waiting for deployment 85fda652-f215-25fd-b13d-e061adccf535 to complete
.................................Done 85fda652-f215-25fd-b13d-e061adccf535
</code></pre>
<p>Here is also a similar shell script. It is simpler than the python code and just launches deployments without waiting for results:</p>
<pre><code class="lang-bash">#!/usr/bin/env bash

STACK_ID=0a000a00-00a0-00a0-0000-00a00000000a
APP_ID=00aa000a-aaaa-000a-0a00-a000000a0000

export AWS_ACCESS_KEY_ID=XXXXXXXXXXXXXXXXXXXX
export AWS_SECRET_ACCESS_KEY=xXXxxxxxXXxXXxxXXxXXxxxxXxxXxxxxXXXxXxXX

aws opsworks --region us-east-1 create-deployment --stack-id $STACK_ID --app-id $APP_ID --command &quot;{\&quot;Name\&quot;:\&quot;update_custom_cookbooks\&quot;}&quot;
aws opsworks --region us-east-1 create-deployment --stack-id $STACK_ID --app-id $APP_ID --command &quot;{\&quot;Name\&quot;:\&quot;deploy\&quot;}&quot;
</code></pre>
<h2 id="links">Links</h2>
<p><a href="http://docs.aws.amazon.com/cli/latest/reference/opsworks/create-deployment.html">OpsWorks cli - create-deployment command</a></p>
<p><a href="http://docs.aws.amazon.com/opsworks/latest/userguide/cli-examples-create-deployment.html">OpsWorks docs:Deploy an App (create-deployment)</a></p>

      </div>
      <div>
<a href="https://stackexchange.com/users/261528">
<img src="https://stackexchange.com/users/flair/261528.png?theme=clean" width="208" height="58" alt="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites">
</a>
      </div>
      <div>
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = 'http://serebrov.github.io/html/2014-12-30-aws-opsworks-cmd-deployment.html';  // Replace PAGE_URL with your page's canonical URL variable
// this.page.identifier = 'html/2014-12-30-aws-opsworks-cmd-deployment.html'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://serebrov.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58056088-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>

