<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Yii and jquery.localtime.js - display dates in user local timezone</title>

    <!-- Bootstrap -->
    <!-- https://github.com/necolas/normalize.css -->
    <link href="/css/normalize.css" rel="stylesheet">
    <!-- https://github.com/oxalorg/sakura -->
    <link href="/css/sakura.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/custom.css"/>

    <!-- https://prismjs.com/ -->
    <!-- Plugins: Line Highlight, Line Numbers, Autolinker, File Highlight,
                  Keep Markup, Normalize Whitespace
    -->
    <!-- Langs: bash, c, cpp, docker, go, haskell, json, makefile, php, plsql,
                python, rust, smalltalk, sql, vim, yaml
    -->
    <link href="/css/prism.css" rel="stylesheet">
    <script src="/js/prism.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  </head>
  <body>
    <div class="content">
      <div class="page-header">
        <a href="/">vim, git, aws and other three-letter words</a>
      </div>
      <div class="post-title">
          <h1>Yii and jquery.localtime.js - display dates in user local timezone</h1>
      </div>
      <div class="post-body">
          <p>With this method we work on the server with UTC timezone dates and convert them
to a user local timezone on client.</p>
<p><!-- more --></p>
<h2 id="use-timestamp-type-for-date-datetime-db-fields">Use ‘TIMESTAMP’ type for date/datetime DB fields</h2>
<h2 id="setup-mysql-and-php-timezone">Setup MySQL and PHP timezone</h2>
<p>Set UTC timezone for both MySQL and PHP.</p>
<p>Yii db config (MySQL):</p>
<pre><code class="lang-php">    ‘db’ =&gt; array(
        &#39;connectionString&#39; =&gt; &#39;...’,
        &#39;initSQLs&#39;=&gt;&quot;set time_zone=&#39;+00:00’;&quot;,
    );
</code></pre>
<p>And PHP timezone:</p>
<pre><code class="lang-php">    date_default_timezone_set(‘UTC’);
</code></pre>
<h2 id="generate-html-with-utc-dates-in-iso-8601">Generate HTML with UTC dates in ISO 8601</h2>
<p>See <a href="http://code.google.com/p/jquery-localtime/wiki/Usage">date formats here</a>
Helper functions to convert dates:</p>
<ul>
<li><p>MySQL date to UTC</p>
<p>  $utcString = gmdate(&#39;Y-m-d\TH:i:s\Z&#39;, strtotime($dateTimeString));</p>
</li>
<li><p>UTC date to HTML</p>
<p>  echo CHtml::tag(&#39;span&#39;, array(&#39;class&#39;=&gt;&#39;localtime&#39;), $utcString);</p>
</li>
<li><p>UTC date to timestamp</p>
<p>   $ts = strtotime($utcString);</p>
</li>
</ul>
<h2 id="add-localtime-plugin-and-localtimex-extension">Add localtime plugin and localtimex extension</h2>
<p>Include scripts into the page, see <a href="http://code.google.com/p/jquery-localtime/">jquery.localtime.js plugin here</a> and
jquery.localtimex.js code at the end.
To disable jquery.localtime.js default initialization pass empty format to setFormat()
method (or remove jQuery.ready block at the end of jquery.localtime.js).</p>
<pre><code class="lang-html">    &lt;script type=&quot;text/javascript&quot; src=&quot;/js/jquery.localtime-0.5.js&quot;&gt;&lt;/script&gt;
    &lt;script type=&quot;text/javascript&quot; src=&quot;/js/jquery.localtimex.js&quot;&gt;&lt;/script&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;$.localtime.setFormat({}); &lt;/script&gt;
</code></pre>
<p>Use localtimex:</p>
<pre><code class="lang-html">    &lt;script type=&quot;text/javascript&quot;&gt;
        $(&#39;.localtime&#39;).localtimex(&#39;dd MMM yyyy HH:mm:ss&#39;);
    &lt;/script&gt;
</code></pre>
<p>By default plugin will localize specified elements and re-localize them in the case of ajax updates.
Date format is ISO 8601, see <a href="http://code.google.com/p/jquery-localtime/wiki/Usage">description</a>.</p>
<h2 id="date-inputs">Date inputs</h2>
<p>jquery.localtimex.js plugin also supports date inputs localization (tested with jQuery UI datepicker and depends on it).</p>
<p>It will convert UTC value to local time, so user can work with it. Before form submit plugin will convert it back to UTC.</p>
<p>Example of usage:</p>
<ol>
<li><p>Use initial UTC value for date input or leave it empty:</p>
<p> $myDate = gmdate(&#39;Y-m-d\TH:i:s\Z&#39;, time()); //today, use it as initial date input value</p>
</li>
<li><p>When configuring the jQuery datepicker plugin - set date format to &#39;mm/dd/yy&#39; and add css class &#39;localdatepicker&#39;.</p>
</li>
<li><p>Attach jquery.localtimex plugin to the same input, set date format to &#39;MM/dd/yyyy&#39; and use css class &#39;localdatepicker&#39;:</p>
<p> $(&#39;.localdatepicker&#39;).localtimex(&#39;MM/dd/yyyy&#39;);</p>
</li>
<li><p>On the client side localtimex plugin will convert initial UTC value to the local client time and then will convert it back when form is submitted</p>
</li>
<li><p>On the server side - accept UTC value, convert it to the MySQL format / timestamp:</p>
<p> $myDateMySql = Yii::app()-&gt;dateFormatter-&gt;format(&#39;yyyy-MM-dd&#39;, strtotime($UTCValue));
 $myDateTimestamp = strtotime($UTCValue);</p>
</li>
</ol>
<pre><code class="lang-js">jquery.localtimex.js
-------------------------------------------
    /**
     * @name jquery.localtimex.js
     * @author Boris Serebrov
     *
     * Depends on: jQuery, jQuery UI datepicker (local date parsing),
     * jquery.localtime-0.5.js (http://code.google.com/p/jquery-localtime/)
     *
     * Usage:
     * - do not configure jquery.localtime plugin, instead use this plugin
     *   on elements you need localize:
     *   $(&#39;.localtime&#39;).localtimex(&#39;dd MMM yyyy HH:mm:ss&#39;);
     *   $(&#39;.localdate&#39;).localtimex(&#39;dd MMM yyyy&#39;);
     *
     * Ajax response handling:
     * - by default plugin will localize elements after ajax requests
     * - to disable this behavior pass &#39;ajaxLocalize&#39;:false to options
     *   $(&#39;.localdate&#39;).localtimex(&#39;dd MMM yyyy&#39;, {&#39;ajaxLocalize&#39;:false});
     *
     * Date inputs handling:
     * - server put UTC time into input (or leave it empty)
     * - UTC value converted to local time, user can modify it in local format
     * - on form submit value converted back to UTC and posted to server
     *
     * jQuery UI datepicker configuration:
     * - add &#39;localtimex&#39; plugin to date input
     * - set dateFormat of a date picker accordingly to localtime plugin output format
     *   - they use different standards for date presentation,
     *     so we have to describe the same presentation twice
     *   - for example: localtime plugin - &#39;MM/dd/yyyy&#39;, datepicker - &#39;mm/dd/yy&#39;
     * - initial input value should be UTC in ISO format or empty
     */
    (function($) {
      $.fn.localtimex = function(format, opt) {

        format = format || &#39;yyyy-MM-dd HH:mm:ss&#39;;
        opt = $.extend({
            &#39;ajaxLocalize&#39;: true
        }, opt);

        if (opt.ajaxLocalize) {
          var self = this;
          $(&#39;body&#39;).ajaxComplete(function() {
            $(self.selector).each(function() {
              $.localtimex.localize(this, format);
            });
          });
        }

        return this.each(function() {
          $.localtimex.localize(this, format);
          if ($(this).is(&quot;:input&quot;)) {
            var self = this;
            $(this.form).on(&#39;submit form-pre-serialize&#39;, function() {
                var dt = $.datepicker.parseDate(
                  $(self).datepicker(&#39;option&#39;, &#39;dateFormat&#39;), $(self).val()
                );
                if (dt) {
                  $(self).val(dt.toISOString());
                }
            });
          }
        });
      };

      $.localtimex = {
        localize: function(element, format) {
          if (!$(element).attr(&#39;data-localized&#39;)) {
            if ($(element).is(&quot;:input&quot;)) {
              var utcVal = $(element).val();
              //input can be empty initially
              if (utcVal.length) {
                $(element).attr(&#39;value&#39;, $.localtime.toLocalTime($(element).val(), format));
              }
            } else {
              $(element).text($.localtime.toLocalTime($(element).text(), format));
            }
          }
          $(element).attr(&#39;data-localized&#39;, true);
        }
      };
    }) (jQuery);
</code></pre>
<h2 id="links">Links</h2>
<p><a href="http://www.yiiframework.com/wiki/197/local-time-zones-and-locales/">Yii wiki: Local time zones and locales</a></p>
<p><a href="http://www.yiiframework.com/wiki/183/using-international-dates/">Yii wiki: Using International Dates</a></p>
<p><a href="http://www.yiiframework.com/extension/i18n-datetime-behavior/">Yii extension: i18n-datetime-behavior</a></p>
<p><a href="http://www.yiiframework.com/forum/index.php/topic/9950-datetime-and-internationalization/">Yii forum: DATETIME and internationalization</a></p>
<p><a href="http://www.yiiframework.com/forum/index.php/topic/3649-dealing-with-i18n-date-formats/">Yii forum: Dealing with i18N date formats</a></p>
<p><a href="http://www.yiiplayground.cubedwater.com/index.php?r=InternationalizationModule/datetime/userinput">Yii playground: User input advanced example</a></p>
<p><a href="http://www.yiiplayground.cubedwater.com/index.php?r=InternationalizationModule/datetime/localeManager">Yii playground: LocaleManager application component</a></p>

      </div>
      <div>
<a href="https://stackexchange.com/users/261528">
<img src="https://stackexchange.com/users/flair/261528.png?theme=clean" width="208" height="58" alt="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites">
</a>
      </div>
      <div>
<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'serebrov'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58056088-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>

