<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Amazon DynamoDB - how to add global secondary index</title>

    <!-- Bootstrap -->
    <!-- https://github.com/necolas/normalize.css -->
    <link href="/css/normalize.css" rel="stylesheet">
    <!-- https://github.com/oxalorg/sakura -->
    <link href="/css/sakura.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/custom.css"/>

    <!-- https://prismjs.com/ -->
    <!-- Plugins: Line Highlight, Line Numbers, Autolinker, File Highlight,
                  Keep Markup, Normalize Whitespace
    -->
    <!-- Langs: bash, c, cpp, docker, go, haskell, json, makefile, php, plsql,
                python, rust, smalltalk, sql, vim, yaml
    -->
    <link href="/css/prism.css" rel="stylesheet">
    <script src="/js/prism.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  </head>
  <body>
    <div class="content">
      <div class="page-header">
        <a href="/">vim, git, aws and other three-letter words</a>
      </div>
      <div class="post-title">
          <h1>Amazon DynamoDB - how to add global secondary index</h1>
      </div>
      <div class="post-body">
          <p>Note: this post is outdated, because it is already possible to add a secondary index to the existing table (it was not possible in earlier DynamoDB versions).</p>
<p>At the moment it is not possible to add a secondary index into the existing table.
This feature is <a href="https://forums.aws.amazon.com/ann.jspa?annID=2650">announced</a> but not yet available.</p>
<p>So the only way is to create a new table and migrate the existing data to it.
This can be done using <a href="http://docs.aws.amazon.com/ElasticMapReduce/latest/DeveloperGuide/emr-what-is-emr.html">Amazon EMR</a>.
<!-- more --></p>
<h3 id="create-the-new-table">Create the new table</h3>
<p>The new table can be created from the DynamoDB console or with code like this (in python / <a href="http://boto.readthedocs.org/en/latest/ref/dynamodb.html">boto</a>):</p>
<pre><code class="lang-python">Table.create(
    &#39;my_table_v2&#39;,
    schema = [HashKey(&#39;my_hash&#39;), RangeKey(&#39;a_range&#39;, data_type=NUMBER)],
    global_indexes = [
        GlobalAllIndex(&#39;SecondaryIndexName&#39;,
            parts=[
                HashKey(&#39;my_another_hash&#39;), RangeKey(&#39;another_range&#39;, data_type=NUMBER)
            ],
            throughput={&#39;read&#39;: 1, &#39;write&#39;: 3}
        )
    ],
    throughput={&#39;read&#39;: 1, &#39;write&#39;: 3})
</code></pre>
<h3 id="move-data-from-the-old-table-to-new-table">Move data from the old table to new table</h3>
<p>This is not complex to implement such data transfer also in python / boto, but if there is a lot of data the process can take long time to complete.</p>
<p>In this case it is much more convenient to use EMR for this - process is launched and monitored and all logs are recorded.</p>
<p>Another option is to use AWS Data Pipeline service, see the example of <a href="http://docs.aws.amazon.com/datapipeline/latest/DeveloperGuide/dp-crossregion-ddb.html">cross-region data copy</a>. Table to table data copy can be done in a similar way.</p>
<p>But in my case the AWS Data Pipeline service was not available for the region where DynamoDB was launched, so I used EMR (and actually data pipeline also uses EMR behind the scenes).</p>
<p>Amazon EMR allows to create a step of type &#39;Hive program&#39; where we can only specify the S3 path to the hive script to run (all other parameters are optional).</p>
<p>So we create and upload to S3 the hive script like shown below and then launch or use existing EMR cluster to transfer the data:</p>
<pre><code class="lang-sql">-- This only removes Hive view for dynamo table, not the table itself
DROP TABLE IF EXISTS my_table;
CREATE EXTERNAL TABLE my_table (my_hash string, a_range bigint, my_another_hash string, another_range bigint)
STORED BY &#39;org.apache.hadoop.hive.dynamodb.DynamoDBStorageHandler&#39;
TBLPROPERTIES (&quot;dynamodb.table.name&quot; = &quot;my_table&quot;,
&quot;dynamodb.column.mapping&quot; = &quot;my_hash:my_hash,a_range:a_range,my_another_hash:my_another_hash,another_range:another_range&quot;);

-- The my_table_v2 should alreay exists in dynamo and have the secondary index
DROP TABLE IF EXISTS my_table_v2;
CREATE EXTERNAL TABLE my_table_v2 (my_hash string, a_range bigint, my_another_hash string, another_range bigint)
STORED BY &#39;org.apache.hadoop.hive.dynamodb.DynamoDBStorageHandler&#39;
TBLPROPERTIES (&quot;dynamodb.table.name&quot; = &quot;my_table_v2&quot;,
&quot;dynamodb.column.mapping&quot; = &quot;my_hash:my_hash,a_range:a_range,my_another_hash:my_another_hash,another_range:another_range&quot;);

-- Use 90% of read/write throughput
SET dynamodb.throughput.read.percent=0.9;
SET dynamodb.throughput.write.percent=0.9;

-- Copy data from table to table
INSERT INTO TABLE my_table_v2 SELECT * FROM my_table;
</code></pre>
<h2 id="view-results">View results</h2>
<p>Once the process is finished EMR will show process logs (controller, syslog, stderr, stdout).
Most of the information is in the <code>stderr</code> log.
Also note that logs are not available just when the process is finished. Just wait few minutes and logs will appear.</p>
<h2 id="links">Links</h2>
<p><a href="http://serebrov.github.io/html/2015-01-24-aws-dynamodb-emr-hive.html">Amazon DynamoDB, EMR and Hive notes</a></p>
<p><a href="http://docs.aws.amazon.com/ElasticMapReduce/latest/DeveloperGuide/EMR_Hive_Optimizing.html">Optimizing Performance for Amazon EMR Operations in DynamoDB</a></p>
<p><a href="http://arjon.es/2014/01/29/hive-dynamodb-pitfalls/">Hive &amp; DynamoDB Pitfalls</a></p>
<p><a href="http://stackoverflow.com/questions/10683136/amazon-elastic-mapreduce-mass-insert-from-s3-to-dynamodb-is-incredibly-slow">Stackoverflow: Amazon Elastic MapReduce - mass insert from S3 to DynamoDB is incredibly slow</a></p>

      </div>
      <div>
<a href="https://stackexchange.com/users/261528">
<img src="https://stackexchange.com/users/flair/261528.png?theme=clean" width="208" height="58" alt="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites">
</a>
      </div>
      <div>
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = 'https://serebrov.github.io/html/2015-01-25-aws-add-secondary-index.html';  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = 'html/2015-01-25-aws-add-secondary-index.html'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://serebrov.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58056088-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>

