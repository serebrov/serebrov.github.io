<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>global ajax response handler and jquery.localtime plugin</title>

    <!-- Bootstrap -->
    <!-- https://github.com/necolas/normalize.css -->
    <link href="/css/normalize.css" rel="stylesheet">
    <!-- https://github.com/oxalorg/sakura -->
    <link href="/css/sakura.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/custom.css"/>

    <!-- https://prismjs.com/ -->
    <!-- Plugins: Line Highlight, Line Numbers, Autolinker, File Highlight,
                  Keep Markup, Normalize Whitespace
    -->
    <!-- Langs: bash, c, cpp, docker, go, haskell, json, makefile, php, plsql,
                python, rust, smalltalk, sql, vim, yaml
    -->
    <link href="/css/prism.css" rel="stylesheet">
    <script src="/js/prism.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  </head>
  <body>
    <div class="content">
      <div class="page-header">
        <a href="/">vim, git, aws and other three-letter words</a>
      </div>
      <div class="post-title">
          <h1>global ajax response handler and jquery.localtime plugin</h1>
      </div>
      <div class="post-body">
          <p>The <a href="http://code.google.com/p/jquery-localtime">jquery.localtime plugin</a> allows to convert date/time strings to a local user time on a client site.
By default it works when the page is loaded initially, but if some elements are updated via ajax then they do not converted and left in an UTC format.</p>
<p>Possible solution is to add some special handling to $.ajax &#39;success&#39; handlers, but it can require a lot of modifications.
Better way is to set some global handler for all ajax requests and apply conversion to local time there.
I evaluated several approaches before I could find a working solution.</p>
<!-- more -->
<h2 id="first-try-run-local-time-conversion-in-ajaxcomplete-doesn-t-work-">First try - run local time conversion in $.ajaxComplete (doesn&#39;t work)</h2>
<pre><code>$(&#39;body&#39;).ajaxComplete(function() {
    //code from jquery.localtime.js, jQuery.ready handler
    var format;
    var localise = function () {
        if (jQuery(this).is(&quot;:input&quot;)) {
            jQuery(this).val(jQuery.localtime.toLocalTime(jQuery(this).val(), format));
        } else {
            jQuery(this).text(jQuery.localtime.toLocalTime(jQuery(this).text(), format));
        }
    };
    var formats = jQuery.localtime.getFormat();
    var cssClass;
    for (cssClass in formats) {
        if (formats.hasOwnProperty(cssClass)) {
            format = formats[cssClass];
            //this will try to convert alrady converted texts and cause an exception
            jQuery(&quot;.&quot; + cssClass).each(localise);
        }
    }
});
</code></pre><p>It doesn&#39;t work because <code>jQuery(&quot;.&quot; + cssClass).each(localise)</code> will try to apply localization to all elements, including these which already present in the page and converted. And localtime plugin starts throwing exceptions because it can not convert already converted data.</p>
<h2 id="second-try-run-local-time-conversion-in-ajaxcomplete-only-for-received-data-doesn-t-work-">Second try - run local time conversion in $.ajaxComplete only for received data (doesn&#39;t work)</h2>
<pre><code>$(&#39;body&#39;).ajaxComplete(function(event, xhr, ajaxOptions) {
    //code from jquery.localtime.js, jQuery.ready handler
    var format;
    var localise = function () {
        if (jQuery(this).is(&quot;:input&quot;)) {
            jQuery(this).val(jQuery.localtime.toLocalTime(jQuery(this).val(), format));
        } else {
            jQuery(this).text(jQuery.localtime.toLocalTime(jQuery(this).text(), format));
        }
    };
    var formats = jQuery.localtime.getFormat();
    var cssClass;
    for (cssClass in formats) {
        if (formats.hasOwnProperty(cssClass)) {
            format = formats[cssClass];
            var result = $(xhr.resultText);
            result.find(&quot;.&quot; + cssClass).each(localise);
            xhr.resultText = //convert result back to text
        }
    }
});
</code></pre><p>It doesn&#39;t work because ajaxComplete is invoked too late - when original $.ajax &#39;success&#39; handler already done its work.</p>
<h2 id="third-try-use-ajaxsetup-converters-doesn-t-work-">Third try - use $.ajaxSetup converters (doesn&#39;t work)</h2>
<pre><code>$.ajaxSetup({
    converters: {
        &quot;html html&quot;: function( textValue ) {
            return localizeText(textValue);
        }
    }
});
</code></pre><p>It doesn&#39;t work because converter is invoked only when we have two different formats like &quot;text html&quot; and we got unexpected format in ajax result.</p>
<h2 id="final-try-use-ajaxsetup-prefilters-works-">Final try - use $.ajaxSetup prefilters (works!)</h2>
<pre><code>jQuery(function($) {
    $.ajaxPrefilter(function(options, originalOptions, jqXHR) {
        var success = options.success;
        //if reqested data type was text or html or *
        if (options.dataTypes.indexOf(&quot;text&quot;) !=-1 ||
            options.dataTypes.indexOf(&quot;html&quot;) != -1 ||
            options.dataTypes.indexOf(&quot;*&quot;) != -1
        ) {
            options.success = function(data, textStatus, jqXHR) {
                // override success handling
                data = localizeText(data);
                if(typeof(success) === &quot;function&quot;) return success(data, textStatus, jqXHR);
            };
        }
    });

    function localizeText(textValue) {
        var format;
        var localise = function () {
            if (jQuery(this).is(&quot;:input&quot;)) {
                jQuery(this).val(jQuery.localtime.toLocalTime(jQuery(this).val(), format));
            } else {
                jQuery(this).text(jQuery.localtime.toLocalTime(jQuery(this).text(), format));
            }
        };
        var formats = jQuery.localtime.getFormat();
        var cssClass;
        //convert text to jQuery var
        var result = $(textValue);
        for (cssClass in formats) {
            if (formats.hasOwnProperty(cssClass)) {
                format = formats[cssClass];
                result.find(&quot;.&quot; + cssClass).each(localise);
            }
        }
        var text = &quot;&quot;;
        //convert jQuery var back to text
        $(result).each(function(index){
            if (this.nodeName.toLowerCase() == &#39;script&#39;) {
                text += &#39;&lt;script type=&quot;text/javascript&quot;&gt;&#39;+$(this).html()+&quot;&lt;/&quot;+&quot;script&gt;&quot;;
            } else if (this.nodeType !== 1) {
                //skip non-elements (HTML comments, text, etc)
                return;
            } else {
                text += $(this).appendTo(&#39;&lt;div&gt;&#39;).parent().html();
            }
        });
        return text;
    }
});
</code></pre><p>This approach finally works.</p>
<p>The tricky part here is also a text-to-jQuery-and-back conversion.
While we can create a jQuery object (or array of objects) like this: <code>$(textValue)</code> and then process it, it is not so easy to convert it back to text.</p>
<p>After the conversion we have <code>result</code> as an array of jQuery object and if we do <code>result.html()</code> than we get only inner HTML of the first item.</p>
<p>And even if we wrap the result into a parent div like this <code>$(result).appendTo(&#39;&lt;div&gt;&#39;).parent().html()</code> than we get HTML but without javascript elements. So we need to iterate over the result and process HTML and javascript elements separately:</p>
<pre><code>$(result).each(function(index){
    if (this.nodeName.toLowerCase() == &#39;script&#39;) {
        text += &#39;&lt;script type=&quot;text/javascript&quot;&gt;&#39;+$(this).html()+&quot;&lt;/&quot;+&quot;script&gt;&quot;;
    } else if (this.nodeType !== 1) {
        //skip non-elements (HTML comments, text, etc)
        return;
    } else {
        text += $(this).appendTo(&#39;&lt;div&gt;&#39;).parent().html();
    }
});
</code></pre><h2 id="links">Links</h2>
<p><a href="http://api.jquery.com/extending-ajax/">Extending Ajax: Prefilters, Converters, and Transports</a></p>
<p><a href="http://api.jquery.com/ajaxComplete/">jQuery docs: $.ajaxComplete()</a></p>
<p><a href="http://stackoverflow.com/questions/7256207/how-can-i-intercept-ajax-responses-in-jquery-before-the-event-handler">Stackowerflow: How can I intercept ajax responses in jQuery before the event handler?</a></p>

      </div>
      <div>
<a href="https://stackexchange.com/users/261528">
<img src="https://stackexchange.com/users/flair/261528.png?theme=clean" width="208" height="58" alt="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites">
</a>
      </div>
      <div>
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = 'https://serebrov.github.io/html/2012-09-25-global-ajax-handler-and-localtime.html';  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = 'html/2012-09-25-global-ajax-handler-and-localtime.html'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://serebrov.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58056088-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>

