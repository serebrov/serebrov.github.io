<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='There are several ways to speedup slow unit tests which interact with database:
 Refactor code and tests and do not interact with db in unit tests Use sqlite db in memory instead of MySql Use MySql MEMORY engine Move MySql data to memory  It is better to try other listed approaches and I think of last method as of quick temporary hack, but here it is:
 stop mysql move /var/lib/mysql to /dev/shm/mysql link /var/lib/mysql to /dev/shm/mysql start mysql  In Ubuntu there is also a problem with apparmor which will not allow mysql to read from /dev/shm.'>
<meta name='theme-color' content='#44ccff'>

<meta property='og:title' content='Speedup unit tests by moving MySql data to memory [Ubuntu] • vim, git, aws and other three-letter words'>
<meta property='og:description' content='There are several ways to speedup slow unit tests which interact with database:
 Refactor code and tests and do not interact with db in unit tests Use sqlite db in memory instead of MySql Use MySql MEMORY engine Move MySql data to memory  It is better to try other listed approaches and I think of last method as of quick temporary hack, but here it is:
 stop mysql move /var/lib/mysql to /dev/shm/mysql link /var/lib/mysql to /dev/shm/mysql start mysql  In Ubuntu there is also a problem with apparmor which will not allow mysql to read from /dev/shm.'>
<meta property='og:url' content='https://serebrov.github.io/html/2012-12-17-unit-speed-mysql-to-mem.html'>
<meta property='og:site_name' content='vim, git, aws and other three-letter words'>
<meta property='og:type' content='article'><meta property='article:section' content='posts'><meta property='article:tag' content='mysql'><meta property='article:published_time' content='2012-04-03T00:00:00Z'/><meta property='article:modified_time' content='2012-04-03T00:00:00Z'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.67.0" />

  <title>Speedup unit tests by moving MySql data to memory [Ubuntu] • vim, git, aws and other three-letter words</title>
  <link rel='canonical' href='https://serebrov.github.io/html/2012-12-17-unit-speed-mysql-to-mem.html'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.6a060eb7.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#44ccff;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-58056088-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-note has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/images/logo.jpg'>
      </a>
    </div>
    
    <h2 class='title site-title '>
      <a href='/'>
      vim, git, aws and other three-letter words
      </a>
    </h2>
    <div class='desc'>
    Software Development Notes
    </div>
  </header>

</section>
<section class='widget widget-search sep-after'>
  <header>
    <h4 class='title widget-title'>Search</h4>
  </header>

  <form action='/search' id='search-form' class='search-form'>
    <label>
      <span class='screen-reader-text'>Search</span>
      <input id='search-term' class='search-term' type='search' name='q' placeholder='Search&hellip;'>
    </label></form>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label='Sidebar Menu'>
    <div class='container'>
      <ul><li class='item'>
  <a href='/'>Home</a></li><li class='item'>
  <a href='/posts/'>Posts</a></li><li class='item'>
  <a href='/archive/'>Archive</a></li></ul>
    </div>
  </nav>

</section><section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Tags</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud no-shuffle'><li>
        <a href='/tags/android/' style='font-size:1em'>android</a>
      </li><li>
        <a href='/tags/angularjs/' style='font-size:1.1176470588235294em'>angularjs</a>
      </li><li>
        <a href='/tags/aws/' style='font-size:2em'>aws</a>
      </li><li>
        <a href='/tags/celery/' style='font-size:1em'>celery</a>
      </li><li>
        <a href='/tags/chrome/' style='font-size:1em'>chrome</a>
      </li><li>
        <a href='/tags/cw-logs/' style='font-size:1.0588235294117647em'>cw-logs</a>
      </li><li>
        <a href='/tags/disqus/' style='font-size:1em'>disqus</a>
      </li><li>
        <a href='/tags/docker/' style='font-size:1em'>docker</a>
      </li><li>
        <a href='/tags/drone/' style='font-size:1em'>drone</a>
      </li><li>
        <a href='/tags/dynamodb/' style='font-size:1.1176470588235294em'>dynamodb</a>
      </li><li>
        <a href='/tags/eb/' style='font-size:1.1764705882352942em'>eb</a>
      </li><li>
        <a href='/tags/ejs/' style='font-size:1em'>ejs</a>
      </li><li>
        <a href='/tags/emr/' style='font-size:1.0588235294117647em'>emr</a>
      </li><li>
        <a href='/tags/express.js/' style='font-size:1em'>express.js</a>
      </li><li>
        <a href='/tags/git/' style='font-size:1.8823529411764706em'>git</a>
      </li><li>
        <a href='/tags/hive/' style='font-size:1em'>hive</a>
      </li><li>
        <a href='/tags/jquery/' style='font-size:1.1764705882352942em'>jquery</a>
      </li><li>
        <a href='/tags/js/' style='font-size:1.1176470588235294em'>js</a>
      </li><li>
        <a href='/tags/linux/' style='font-size:1em'>linux</a>
      </li><li>
        <a href='/tags/mongodb/' style='font-size:1em'>mongodb</a>
      </li><li>
        <a href='/tags/mysql/' style='font-size:1.0588235294117647em'>mysql</a>
      </li><li>
        <a href='/tags/node.js/' style='font-size:1.1764705882352942em'>node.js</a>
      </li><li>
        <a href='/tags/npm/' style='font-size:1em'>npm</a>
      </li><li>
        <a href='/tags/oauth/' style='font-size:1em'>oauth</a>
      </li><li>
        <a href='/tags/oop/' style='font-size:1em'>oop</a>
      </li><li>
        <a href='/tags/php/' style='font-size:1.1764705882352942em'>php</a>
      </li><li>
        <a href='/tags/postgresql/' style='font-size:1em'>postgresql</a>
      </li><li>
        <a href='/tags/python/' style='font-size:1.1176470588235294em'>python</a>
      </li><li>
        <a href='/tags/rds/' style='font-size:1em'>rds</a>
      </li><li>
        <a href='/tags/scaleway/' style='font-size:1em'>scaleway</a>
      </li><li>
        <a href='/tags/selenium/' style='font-size:1.3529411764705883em'>selenium</a>
      </li><li>
        <a href='/tags/ssh/' style='font-size:1em'>ssh</a>
      </li><li>
        <a href='/tags/typing/' style='font-size:1em'>typing</a>
      </li><li>
        <a href='/tags/vim/' style='font-size:1em'>vim</a>
      </li><li>
        <a href='/tags/yii/' style='font-size:1.1764705882352942em'>yii</a>
      </li><li>
        <a href='/tags/zeromq/' style='font-size:1em'>zeromq</a>
      </li></ul>
</div>


</section>
</div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    <a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/'>Home</a>
      </li><li class='item'>
        <a href='/posts/'>Posts</a>
      </li><li class='item'>
        <a href='/archive/'>Archive</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'>
    
    <style>.widget-breadcrumbs li:after{content:'\2f '}</style>
  <section class='widget widget-breadcrumbs sep-after'>
    <nav id='breadcrumbs'>
      <ol><li><a href='/'>Home</a></li><li><a href='/posts/'>Posts</a></li><li><span>Speedup unit tests by moving MySql data to memory [Ubuntu]</span></li></ol>
    </nav>
  </section></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>vim, git, aws and other three-letter words</p><p class='desc site-desc'>Software Development Notes</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Speedup unit tests by moving MySql data to memory [Ubuntu]</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2012-04-03T00:00:00Z'>2012, Apr 03</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
2 mins read
</span>


  
  
</div>


  </div>
</header>

  
  

  <div class="container entry-content custom">
    <p>There are several ways to speedup slow unit tests which interact with database:</p>
<ul>
<li>Refactor code and tests and do not interact with db in unit tests</li>
<li>Use sqlite db in memory instead of MySql</li>
<li>Use MySql MEMORY engine</li>
<li>Move MySql data to memory</li>
</ul>
<!-- raw HTML omitted -->
<p>It is better to try other listed approaches and I think of last method as of quick temporary hack, but here it is:</p>
<ul>
<li>stop mysql</li>
<li>move /var/lib/mysql to /dev/shm/mysql</li>
<li>link /var/lib/mysql to /dev/shm/mysql</li>
<li>start mysql</li>
</ul>
<p>In Ubuntu there is also a problem with apparmor which will not allow mysql to read from /dev/shm.
To fix this it is recommended to add following to the <code>/etc/apparmor.d/usr.sbin.mysqld</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    /dev/shm/mysql/ r,
    /dev/shm/mysql/** rwk,
</code></pre></div><p>But it doesn&rsquo;t work for me and I disabled apparmor for mysql (not recommended):</p>
<pre><code>sudo mv /etc/apparmor.d/usr.sbin.mysqld /etc/apparmor.d/disable
</code></pre>
<p>Below are shell scripts to move MySql data to /dev/shm and back, restore backed up data and check db state.</p>
<h2 id="move-db-to-memory-script">Move db to memory script</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    <span style="color:#75715e">#!/bin/sh</span>
    <span style="color:#75715e">#Check if run as root</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">`</span>whoami<span style="color:#e6db74">`</span> !<span style="color:#f92672">=</span> root <span style="color:#f92672">]</span>
    <span style="color:#66d9ef">then</span>
        echo <span style="color:#e6db74">&#34;You must be root to do that!&#34;</span>
        exit <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>

    service mysql stop
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -s /var/lib/mysql.backup <span style="color:#f92672">]</span>
    <span style="color:#66d9ef">then</span>
        cp -pRL /var/lib/mysql /var/lib/mysql.backup
    <span style="color:#66d9ef">fi</span>
    mv /var/lib/mysql /dev/shm/mysql
    chown -R mysql:mysql /dev/shm/mysql
    ln -s /dev/shm/mysql /var/lib/mysql
    chown -h mysql:mysql /var/lib/mysql
    service mysql start
</code></pre></div><h2 id="move-db-to-disk-script">Move db to disk script</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    <span style="color:#75715e">#!/bin/sh</span>
    <span style="color:#75715e">#Check if run as root</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">`</span>whoami<span style="color:#e6db74">`</span> !<span style="color:#f92672">=</span> root <span style="color:#f92672">]</span>
    <span style="color:#66d9ef">then</span>
        echo <span style="color:#e6db74">&#34;You must be root to do that!&#34;</span>
        exit <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>

    service mysql stop
    rm /var/lib/mysql
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -s /dev/shm/mysql <span style="color:#f92672">]</span>
    <span style="color:#66d9ef">then</span>
        cp -pRL /var/lib/mysql.backup /var/lib/mysql
    <span style="color:#66d9ef">else</span>
        mv /dev/shm/mysql /var/lib/mysql
    <span style="color:#66d9ef">fi</span>
    service mysql start
</code></pre></div><h2 id="restore-db-backup-script">Restore db backup script</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    <span style="color:#75715e">#!/bin/sh</span>
    <span style="color:#75715e">#Check if run as root</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">`</span>whoami<span style="color:#e6db74">`</span> !<span style="color:#f92672">=</span> root <span style="color:#f92672">]</span>
    <span style="color:#66d9ef">then</span>
        echo <span style="color:#e6db74">&#34;You must be root to do that!&#34;</span>
        exit <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>

    service mysql stop
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -s /var/lib/mysql.backup <span style="color:#f92672">]</span>
    <span style="color:#66d9ef">then</span>
        exit -1
    <span style="color:#66d9ef">fi</span>
    rm /var/lib/mysql
    cp -pRL /var/lib/mysql.backup /var/lib/mysql
    rm -rf /dev/shm/mysql
    service mysql start
</code></pre></div><h2 id="check-db-state-script">Check db state script</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">    <span style="color:#75715e">#!/bin/sh</span>
    <span style="color:#75715e">#Check if run as root</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">`</span>whoami<span style="color:#e6db74">`</span> !<span style="color:#f92672">=</span> root <span style="color:#f92672">]</span>
    <span style="color:#66d9ef">then</span>
        echo <span style="color:#e6db74">&#34;You must be root to do that!&#34;</span>
        exit <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -L /var/lib/mysql <span style="color:#f92672">]</span>
    <span style="color:#66d9ef">then</span>
        echo <span style="color:#e6db74">&#34;Mem db&#34;</span>
        exit <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">else</span>
        echo <span style="color:#e6db74">&#34;File db&#34;</span>
        exit <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">fi</span>
</code></pre></div><h2 id="links">Links</h2>
<p><a href="http://stackoverflow.com/questions/9500032/unit-test-application-including-database-is-too-slow">Unit test application including database is too slow</a></p>
<p><a href="http://stackoverflow.com/questions/4894850/force-an-entire-mysql-database-to-be-in-memory">Force an entire MySQL database to be in memory</a></p>
<p><a href="http://stackoverflow.com/questions/3096148/how-to-run-djangos-test-database-only-in-memory">How to run django&rsquo;s test database only in memory?</a></p>
<p><a href="https://gist.github.com/1152547">Script to put mysqld on a ram disk in ubuntu 10.04. Runs on every hudson slave boot</a></p>
<p><a href="http://www.indimon.co.uk/2012/mysql-tmpdir-on-devshm/">MySQL tmpdir on /dev/shm</a></p>
<p><a href="http://stackoverflow.com/questions/2783313/how-can-i-get-around-mysql-errcode-13-with-select-into-outfile">How can I get around MySQL Errcode 13 with SELECT INTO OUTFILE?</a></p>
 <a href="https://stackexchange.com/users/261528">
<img src="https://stackexchange.com/users/flair/261528.png?theme=clean" width="208" height="58" alt="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites">
</a>

</div>
<div class="popup">
    <div class="close">close</div>
    <div class="download">
        <a href="" target="_blank">Download (<span class="name"></span>)</a>
    </div>
    <div class="popup-content"></div>
</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/mysql/'>mysql</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/html/2012-04-03-git-rename-branch.html'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>vim - replace a word with yanked text</a>
    </div><div class='next-entry sep-before'>
      <a href='/html/2012-03-15-oauth-1-0.html'>
        <span class='screen-reader-text'>Next post: </span>git - rename branch (local and remote)<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>


<section id='comments' class='comments'>
  <div class='container sep-before'>
    <div class='comments-area'><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "serebrov" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
  </div>
</section>

      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/serebrov' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:serebrov@gmail.com' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p> &copy; 2020 Boris Serebrov </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='https://serebrov.github.io/assets/js/main.67d669ac.js'></script><script src='/js/jquery.min.js'></script><script src='/js/custom.js'></script>


</body>

</html>






















