<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elastic Beanstalk - deploy from different machines / by different users (or how to get rid of absolute paths in configs)</title>

    <!-- Bootstrap -->
    <!-- https://github.com/necolas/normalize.css -->
    <link href="/css/normalize.css" rel="stylesheet">
    <!-- https://github.com/oxalorg/sakura -->
    <link href="/css/sakura.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/custom.css"/>

    <!-- https://prismjs.com/ -->
    <!-- Plugins: Line Highlight, Line Numbers, Autolinker, File Highlight,
                  Keep Markup, Normalize Whitespace
    -->
    <!-- Langs: bash, c, cpp, docker, go, haskell, json, makefile, php, plsql,
                python, rust, smalltalk, sql, vim, yaml
    -->
    <link href="/css/prism.css" rel="stylesheet">
    <script src="/js/prism.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  </head>
  <body>
    <div class="content">
      <div class="page-header">
        <a href="/">vim, git, aws and other three-letter words</a>
      </div>
      <div class="post-title">
          <h1>Elastic Beanstalk - deploy from different machines / by different users (or how to get rid of absolute paths in configs)</h1>
      </div>
      <div class="post-body">
          <p>By default Elastic Beanstalk console tool (eb) adds config files to .gitignore.
If there are manual changes to EB configs it can be complex to manually sync these changes
between different machines / different users.
Of cause it is possible to add config files to git repository but there are also several
parameters in the main config which are absolute paths to local files.
This way it makes configs not useful for other users (except for the case when different
users have exactly the same files layout).
Here is how this problem can be fixed:</p>
<ol>
<li>Add eb tools under git control</li>
<li>Add eb configs under git control</li>
<li>Patch eb tools to accept relative file paths</li>
<li>Change paths in configs to relative</li>
</ol>
<p>Below are details for each step.</p>
<!-- more -->
<h2 id="add-eb-tools-under-git-control">Add eb tools under git control</h2>
<p>This is necessary because we want all users to have the same tools version.
Also we are going to make some changes to eb sources to make it understand relative paths.</p>
<p>Just download <a href="http://aws.amazon.com/code/6752709412171743">eb tools</a> and extract somewhere inside your project.
Or copy existing version into the project.</p>
<p>Add a wrapper script to run the original eb tool:</p>
<pre><code class="lang-bash">    #!/bin/sh

    # Run the eb tool from the root project directory as
    # console/eb {parameters}
    # Use linux python2.7 version

    SCRIPT_PATH=`dirname $0`

    export PATH=$PATH:$SCRIPT_PATH/AWS-ElasticBeanstalk-CLI-2.5.1/eb/linux/python2.7
    eb &quot;$@&quot;
</code></pre>
<p>Script should be on the same lever as the extracted directory.
For example I have:</p>
<pre><code class="lang-bash">    project_root/
    | .ebextensions/
    | .elasticbeanstalk/
    | .git/
    | application/
    | console/
    | | AWS-ElasticBeanstalk-CLI-2.5.1/
    | | eb*
    | | ...
    | ...
    | .gitignore
</code></pre>
<p>So I launch the &#39;eb&#39; as &#39;console/eb parameters&#39; from the project root directory.</p>
<h2 id="add-eb-configs-under-git-control">Add eb configs under git control</h2>
<p>Add the EB configs under git control:</p>
<pre><code class="lang-bash">    $ git add -f .elasticbeanstalk
</code></pre>
<h2 id="patch-eb-tools-to-accept-relative-file-paths">Patch eb tools to accept relative file paths</h2>
<p>For the 2.5.1 version I had to make two changes in the config file parser class.</p>
<p>The file path is .../AWS-ElasticBeanstalk-CLI-2.5.1/eb/linux/python2.7/lib/utility/configfile_parser.py.</p>
<p>And the changes are:</p>
<pre><code class="lang-bash">    [Lines 41 - 47]
    def read(self, pathfilename):
        #seb: expand path to allow using homedir and relative paths
        pathfilename = os.path.realpath(os.path.expanduser(pathfilename))
        print &#39;Load sectioned config file: &#39; + pathfilename

        with codecs.open(pathfilename, &#39;r&#39;, encoding=ServiceDefault.CHAR_CODEC) as input_file:
            _RawConfigParser.readfp(self, input_file)

    [Lines 74 - 80]
    def read(self, pathfilename):
        #seb: expand path to allow using homedir and relative paths
        pathfilename = os.path.realpath(os.path.expanduser(pathfilename))
        print &#39;Load config file: &#39; + pathfilename

        with codecs.open(pathfilename, &#39;r&#39;, encoding=ServiceDefault.CHAR_CODEC) as input_file:
            config_pairs = input_file.read()
</code></pre>
<p>Now you can use relative to project root paths in your configs.</p>
<h2 id="change-paths-in-configs-to-relative">Change paths in configs to relative</h2>
<p>I had three absolute paths in my ./elasticbeanstalk/config:</p>
<pre><code class="lang-bash">    [global]
    ..
    AwsCredentialFile=/home/username/.elasticbeanstalk/aws_credential_file
    ..

    [branches]
    staging=staging
    production=production

    [branch:staging]
    OptionSettingFile=/path/to/project/.elasticbeanstalk/optionsettings.staging
    ...

    [branch:production]
    OptionSettingFile=/path/to/project/.elasticbeanstalk/optionsettings.production
    ..
</code></pre>
<p>Path to aws credential file can be easily fixed by just removing it - eb tools will use
config from your home dir by default (~/.elacticbeanstalk/aws_credential_file).</p>
<p>Other two paths (for branch configs) can now be changed to relative:</p>
<pre><code class="lang-bash">    [global]
    # Default credential file path (recognized by both eb tool and git aws.push tool)
    # AwsCredentialFile=~/.elasticbeanstalk/aws_credential_file
    ...

    [branches]
    staging=staging
    production=production

    [branch:staging]
    OptionSettingFile=./.elasticbeanstalk/optionsettings.staging
    ...

    [branch:production]
    OptionSettingFile=./.elasticbeanstalk/optionsettings.production
    ...
</code></pre>
<h2 id="use-it">Use it</h2>
<p>Make sure you are using the &#39;eb&#39; wrapper script from the root project directory.
For example, for &#39;eb status&#39;:</p>
<pre><code class="lang-bash">    $ cd project/root/dir
    $ ./path/to/eb status
    Load sectioned config file: project/root/dir/.elasticbeanstalk/config
    Load config file: /home/user/.elasticbeanstalk/aws_credential_file
    URL    : staging-jp48gay9nx.elasticbeanstalk.com
    Status    : Ready
    Health    : Green
</code></pre>

      </div>
      <div>
<a href="https://stackexchange.com/users/261528">
<img src="https://stackexchange.com/users/flair/261528.png?theme=clean" width="208" height="58" alt="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites">
</a>
      </div>
      <div>
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = 'http://serebrov.github.io/html/2013-09-11-elastic-beanstalk-configs.html';  // Replace PAGE_URL with your page's canonical URL variable
// this.page.identifier = 'html/2013-09-11-elastic-beanstalk-configs.html'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://serebrov.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58056088-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>

