<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AWS PostgreSQL RDS - remaining connection slots are reserved error</title>

    <!-- Bootstrap -->
    <!-- https://github.com/necolas/normalize.css -->
    <link href="/css/normalize.css" rel="stylesheet">
    <!-- https://github.com/oxalorg/sakura -->
    <link href="/css/sakura.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/custom.css"/>

    <!-- https://prismjs.com/ -->
    <!-- Plugins: Line Highlight, Line Numbers, Autolinker, File Highlight,
                  Keep Markup, Normalize Whitespace
    -->
    <!-- Langs: bash, c, cpp, docker, go, haskell, json, makefile, php, plsql,
                python, rust, smalltalk, sql, vim, yaml
    -->
    <link href="/css/prism.css" rel="stylesheet">
    <script src="/js/prism.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  </head>
  <body>
    <div class="content">
      <div class="page-header">
        <a href="/">vim, git, aws and other three-letter words</a>
      </div>
      <small class="pull-right"> 2015-09-22 </small>
      <div class="post-title">
          <h1>AWS PostgreSQL RDS - remaining connection slots are reserved error</h1>
      </div>
      <div class="post-body">
          <p>Today I had a problem with PostgreSQL connection, both my application and psql tool returned an error:</p>
<pre><code class="lang-bash">FATAL:  remaining connection slots are reserved for non-replication superuser connections
</code></pre>
<p>The PostgreSQL server was running on the db.t1.micro RDS instance and the &#39;Current activity&#39; column showed &#39;22 connections&#39; and a red line which should represent a connection limit was far away from the 22 value.</p>
<!-- more -->
<p>Here is how it looked:</p>
<p><img src="files/2015-09-22-22-connections.png" alt="cwl-setup.config, click to preview">.</p>
<p>And this connection information is actually misleading - it shows 22 connections and it looks like around 30% consumed.
While actually we already at 100% of connections.</p>
<p>After some time, when the database load went down, I was able to login with psql to check max_connections parameter:</p>
<pre><code class="lang-sql">template1=&gt; show max_connections;
  max_connections
-----------------
 26
(1 row)
</code></pre>
<p>So we have 26 max connections and, as stated in comments (thanks, Johannes Schickling), there are also 3 connections reserved to superuser.</p>
<p>That means we used 25 connections (22 + 3 reserved) out of 26.</p>
<p>The <code>max_connection</code> setting can also be found in the RDS UI, under &quot;Parameter Groups&quot;, but the value there is set as <code>{DBInstanceClassMemory/31457280}</code>, so it is complex to be sure about the actual value.
The db.t1.micro instance has 1GB memory, and calculation like <code>1024*1024*1024/31457280</code> gives around 36, while actually it is 26.</p>
<p>The default value can be changed this way:</p>
<ul>
<li>create a new parameter group</li>
<li>using the default group as parent and then edit the max_connection value</li>
<li>once done - go to the db instance settings (Modify action) and set the new parameter group.</li>
</ul>
<p>But for me it seems to be dangerous solution to use in production, because more connections will consume more memory and instead of connection limit errors you can end up with out of memory errors.</p>
<p>So I decided to change the instance type to db.t2.small, it costs twice more, but it has 2GB RAM and default max_connections value is 60.</p>
<p>In my case the higher connection consumption was not something unexpected, the Elastic Beanstalk scaled the application to 6 EC2 instances under load. Each instance runs a flask application with several threads, so they can easily consume around 20 connections.
To actually make sure that everything is OK with connections handling, run the following query:</p>
<pre><code class="lang-sql">template1=&gt; select * from pg_stat_activity;

 datid |  datname | ... |    backend_start    | ... |     query_start     |    state_change     | waiting | state | ... |  query
-------+----------+-----+---------------------+-----+---------------------+---------------------+---------+-------+-----+--------------------------
 ...
 16395 | myapp    | ... | 2015-09-22 16:13:04 | ... | 2015-09-22 17:07:13 | 2015-09-22 17:07:13 | f       | idle  | ... | COMMIT
 16395 | myapp    | ... | 2015-09-22 16:14:13 | ... | 2015-09-22 17:07:21 | 2015-09-22 17:07:21 | f       | idle  | ... | ROLLBACK
 16395 | myapp    | ... | 2015-09-22 16:14:13 | ... | 2015-09-22 17:07:14 | 2015-09-22 17:07:14 | f       | idle  | ... | COMMIT
 16395 | myapp    | ... | 2015-09-22 16:14:13 | ... | 2015-09-22 17:07:18 | 2015-09-22 17:07:18 | f       | idle  | ... | ROLLBACK
 ...
(16 rows)
</code></pre>
<p>Here you can see all the connections, queries and last activity time for each connection, so it should be easy to see if there are any hanging connections.</p>
<h1 id="links">Links</h1>
<p><a href="http://stackoverflow.com/questions/11847144/heroku-psql-fatal-remaining-connection-slots-are-reserved-for-non-replication">Stackoverflow: Heroku “psql: FATAL: remaining connection slots are reserved for non-replication superuser connections”</a></p>
<p><a href="http://stackoverflow.com/questions/20106536/amazon-rds-postgres-connection-limit">Stackoverflow: Amazon RDS (postgres) connection limit?</a></p>
<p><a href="http://stackoverflow.com/questions/18291180/flask-unittest-and-sqlalchemy-using-all-connections">Stackoverflow: Flask unittest and sqlalchemy using all connections</a></p>
<p><a href="http://serverfault.com/questions/577712/postgresql-error-no-more-connections-allowed">Stackoverflow: PostgreSQL ERROR: no more connections allowed</a></p>

      </div>
      <div>
<a href="https://stackexchange.com/users/261528">
<img src="https://stackexchange.com/users/flair/261528.png?theme=clean" width="208" height="58" alt="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites" title="profile for Boris Serebrov on Stack Exchange, a network of free, community-driven Q&amp;A sites">
</a>
      </div>
      <div>
<div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = 'http://serebrov.github.io/html/2015-09-22-aws-postgresql-max-connections.html';  // Replace PAGE_URL with your page's canonical URL variable
// this.page.identifier = 'html/2015-09-22-aws-postgresql-max-connections.html'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://serebrov.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58056088-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>

